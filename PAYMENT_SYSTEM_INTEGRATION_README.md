# نظام طرق الدفع المتكامل - دليل الاستخدام

## نظرة عامة
تم تطوير نظام طرق الدفع ليكون متكاملاً مع شراء الكتب واستقبال المدفوعات. النظام يدعم طرق دفع متقدمة ومحلية مع إدارة شاملة من لوحة التحكم.

## الميزات الرئيسية

### 1. طرق الدفع المدعومة
- **بطاقات الائتمان**: Visa, Mastercard, American Express
- **بطاقة مدى**: بطاقة مدى السعودية
- **المحافظ الإلكترونية**: PayPal, Apple Pay, Google Pay, STC Pay
- **الدفع على أقساط**: Tabby (4 أقساط), Tamara (3 أقساط)
- **بوابات دفع محلية**: Urway
- **طرق تقليدية**: تحويل بنكي, دفع عند الاستلام

### 2. إدارة متكاملة
- **إدارة بوابات الدفع**: تفعيل/إلغاء, إعدادات متقدمة
- **إدارة طرق الدفع**: تفعيل/إلغاء حسب البوابة
- **إعدادات الأمان**: وضع تجريبي/إنتاجي
- **مراقبة الحالة**: تفعيل/إلغاء فوري

## كيفية الاستخدام

### للمستخدمين العاديين

#### 1. إتمام الطلب
- **المنتجات الرقمية**: اختيار طريقة دفع فقط (لا حاجة للشحن)
- **المنتجات المادية**: اختيار طريقة دفع + عنوان شحن + طريقة شحن

#### 2. اختيار طريقة الدفع
- عرض الشعارات الرسمية لطرق الدفع
- معلومات واضحة عن كل طريقة
- خيارات الأقساط (إذا كانت متاحة)
- وقت المعالجة

#### 3. إتمام الدفع
- دفع فوري للمنتجات الرقمية
- دفع + شحن للمنتجات المادية
- تأكيد فوري للطلب

### للمديرين

#### 1. الوصول لإدارة طرق الدفع
```
/dashboard/payment-methods
```

#### 2. إدارة بوابات الدفع
- **تفعيل/إلغاء** البوابات
- **إعدادات متقدمة** لكل بوابة
- **وضع تجريبي** للاختبار
- **مفاتيح API** وإعدادات الأمان

#### 3. إدارة طرق الدفع
- **تفعيل/إلغاء** طرق الدفع
- **ربط مع البوابات** المفعلة
- **إعدادات الرسوم** والأقساط
- **مراقبة الحالة** في الوقت الفعلي

## إعدادات متقدمة

### 1. Stripe
```javascript
{
  publishableKey: 'pk_test_...',
  secretKey: 'sk_test_...',
  webhookSecret: 'whsec_...',
  sandboxMode: true
}
```

### 2. PayPal
```javascript
{
  clientId: 'your_client_id',
  clientSecret: 'your_client_secret',
  mode: 'sandbox' // sandbox, live
}
```

### 3. Tabby
```javascript
{
  publicKey: 'your_public_key',
  secretKey: 'your_secret_key',
  webhookSecret: 'your_webhook_secret',
  sandboxMode: true
}
```

### 4. Tamara
```javascript
{
  publicKey: 'your_public_key',
  secretKey: 'your_secret_key',
  webhookSecret: 'your_webhook_secret',
  sandboxMode: true
}
```

## التكامل مع النظام

### 1. CheckoutPage.jsx
- **عرض طرق الدفع** حسب نوع المنتج
- **إخفاء الشحن** للمنتجات الرقمية
- **رسائل توضيحية** للمستخدم

### 2. PaymentMethodSection
- **شعارات رسمية** لطرق الدفع
- **معلومات شاملة** بدون رسوم للمستخدم
- **حالة البوابة** (مفعلة/ملغية)

### 3. DashboardPaymentMethods
- **إدارة شاملة** لطرق الدفع
- **إعدادات متقدمة** لكل بوابة
- **مراقبة الحالة** في الوقت الفعلي

## معالجة الأخطاء

### 1. أخطاء شائعة
- **بوابة غير مفعلة**: تفعيل البوابة من لوحة التحكم
- **مفاتيح API خاطئة**: تحديث المفاتيح في إعدادات البوابة
- **اتصال Firebase**: التحقق من اتصال Firebase

### 2. حل المشاكل
```javascript
// التحقق من حالة البوابة
const isAvailable = await api.payments.isPaymentMethodAvailable('stripe');

// الحصول على طرق الدفع المتاحة
const methods = await api.payments.getAvailablePaymentMethods();

// معالجة الدفع المتقدم
const result = await api.checkout.processAdvancedPayment(orderId, 'tabby', {
  installmentPlan: 4
});
```

## الأمان

### 1. إعدادات الأمان
- **مفاتيح API** مشفرة
- **وضع تجريبي** للاختبار
- **webhooks** للتحقق من المدفوعات
- **تشفير البيانات** الحساسة

### 2. أفضل الممارسات
- **استخدام HTTPS** دائماً
- **تحديث المفاتيح** بانتظام
- **مراقبة السجلات** باستمرار
- **اختبار في البيئة التجريبية** أولاً

## الدعم

### 1. التوثيق
- **API Reference**: `src/lib/services/`
- **نماذج البيانات**: `src/lib/models/`
- **مكونات الواجهة**: `src/components/`

### 2. المساعدة
- **سجلات الأخطاء**: Console + Firebase
- **اختبار الاتصال**: `api.checkConnection()`
- **إعادة المحاولة**: `api.retryOperation()`

## الخلاصة

النظام الجديد يوفر:
- ✅ **تكامل كامل** مع شراء الكتب
- ✅ **طرق دفع متقدمة** ومحلية
- ✅ **إدارة شاملة** من لوحة التحكم
- ✅ **واجهة مستخدم محسنة** مع شعارات واضحة
- ✅ **أمان عالي** وإعدادات متقدمة
- ✅ **دعم المنتجات الرقمية** والمادية

جرب النظام الآن وستجد أنه يعمل بشكل متكامل ومتطور!

